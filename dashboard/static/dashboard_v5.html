<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard V5 - Phase 1</title>
    <script>
        // Console suppression - MUST be first!
        (function() {
            var warn = console.warn;
            var log = console.log;
            var error = console.error;

            console.warn = function() {
                var args = Array.prototype.slice.call(arguments);
                var msg = args.join(' ');
                if (!/Download the React DevTools|tailwindcss\.com should not be used in production|Babel transformer|precompile your scripts/.test(msg)) {
                    warn.apply(console, args);
                }
            };

            console.log = function() {
                var args = Array.prototype.slice.call(arguments);
                var msg = args.join(' ');
                if (!/Download the React DevTools/.test(msg)) {
                    log.apply(console, args);
                }
            };

            console.error = function() {
                var args = Array.prototype.slice.call(arguments);
                var msg = args.join(' ');
                if (!/Violation.*handler took/.test(msg)) {
                    error.apply(console, args);
                }
            };
        })();
    </script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Silent Tailwind config

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#172033',
                            950: '#0a0f1a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Pulse animation for live indicators */
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
        }
        .pulse-live { animation: pulse-green 2s infinite; }

        /* Gradient borders */
        .gradient-border {
            position: relative;
        }
        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.5), rgba(139, 92, 246, 0.5));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        /* Table hover rows */
        .table-row-hover:hover { background: rgba(51, 65, 85, 0.3); }

        /* Toast slide-in animation */
        @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }

        /* Skeleton shimmer animation */
        @keyframes shimmer { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { AreaChart, Area, LineChart, Line, XAxis, YAxis, ResponsiveContainer, Tooltip, PieChart, Pie, Cell, BarChart, Bar } = window.Recharts;

        // =====================================
        // ICONS (SVG Components)
        // =====================================
        const Icons = {
            Wifi: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" /></svg>,
            WifiOff: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" /></svg>,
            Zap: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
            Clock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Bell: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
            RefreshCw: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
            Settings: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            DollarSign: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Shield: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
            TrendingDown: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>,
            TrendingUp: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>,
            Percent: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
            BarChart3: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            Activity: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M22 12h-4l-3 9L9 3l-3 9H2" /></svg>,
            Brain: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>,
            Target: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
            Eye: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            Pause: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Play: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            AlertTriangle: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
            AlertCircle: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Info: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            CheckCircle: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            XCircle: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            ChevronDown: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
            ChevronUp: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>,
            Sun: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Cloud: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>,
            Building: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
            Trophy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Copy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
            List: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>,
        };

        // =====================================
        // ERROR BOUNDARY
        // =====================================
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error('Dashboard error:', error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return React.createElement('div', {
                        className: 'p-4 bg-red-500/10 border border-red-500/30 rounded-xl text-center'
                    },
                        React.createElement('p', { className: 'text-red-400 font-semibold' }, 'Something went wrong'),
                        React.createElement('p', { className: 'text-slate-500 text-sm mt-1' }, this.state.error?.message || 'Unknown error'),
                        React.createElement('button', {
                            className: 'mt-3 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg text-sm',
                            onClick: () => this.setState({ hasError: false, error: null })
                        }, 'Retry')
                    );
                }
                return this.props.children;
            }
        }

        // =====================================
        // TOAST NOTIFICATION SYSTEM
        // =====================================
        const ToastContext = React.createContext(null);

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);

            const addToast = useCallback((message, type = 'info', duration = 5000) => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                if (duration > 0) {
                    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), duration);
                }
            }, []);

            const removeToast = useCallback((id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            }, []);

            return (
                <ToastContext.Provider value={{ addToast, removeToast }}>
                    {children}
                    <div className="fixed top-4 right-4 z-50 space-y-2 max-w-sm">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`flex items-start gap-3 p-4 rounded-lg shadow-xl border backdrop-blur animate-slide-in ${
                                toast.type === 'success' ? 'bg-emerald-900/90 border-emerald-500/30 text-emerald-200' :
                                toast.type === 'error' ? 'bg-red-900/90 border-red-500/30 text-red-200' :
                                toast.type === 'warning' ? 'bg-amber-900/90 border-amber-500/30 text-amber-200' :
                                'bg-slate-800/90 border-slate-600/30 text-slate-200'
                            }`}>
                                <div className="flex-1 text-sm">{toast.message}</div>
                                <button onClick={() => removeToast(toast.id)} className="text-slate-400 hover:text-slate-200">
                                    <Icons.XCircle />
                                </button>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToast = () => React.useContext(ToastContext);

        // =====================================
        // CONFIRM DIALOG
        // =====================================
        const ConfirmDialog = ({ open, title, message, onConfirm, onCancel, confirmLabel = "Confirm", confirmClass = "bg-red-600 hover:bg-red-500" }) => {
            if (!open) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                    <div className="bg-slate-800 border border-slate-700 rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                        <h3 className="text-lg font-semibold text-slate-100 mb-2">{title}</h3>
                        <p className="text-sm text-slate-400 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg text-sm">Cancel</button>
                            <button onClick={onConfirm} className={`px-4 py-2 ${confirmClass} text-white rounded-lg text-sm font-medium`}>{confirmLabel}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // =====================================
        // SKELETON LOADING COMPONENTS
        // =====================================
        const Skeleton = ({ className = "" }) => (
            <div className={`animate-pulse bg-slate-700/50 rounded ${className}`} />
        );

        const CardSkeleton = () => (
            <Card className="p-4 space-y-3">
                <Skeleton className="h-4 w-1/3" />
                <Skeleton className="h-8 w-2/3" />
                <Skeleton className="h-3 w-1/2" />
            </Card>
        );

        // =====================================
        // PERSISTED STATE HOOK
        // =====================================
        const usePersistedState = (key, defaultValue) => {
            const [state, setState] = useState(() => {
                try { const saved = localStorage.getItem(`dashboard_${key}`); return saved ? JSON.parse(saved) : defaultValue; }
                catch { return defaultValue; }
            });
            const setPersistedState = useCallback((value) => {
                setState(value);
                try { localStorage.setItem(`dashboard_${key}`, JSON.stringify(value)); } catch {}
            }, [key]);
            return [state, setPersistedState];
        };

        // =====================================
        // AI BOTS DATA FETCHING
        // =====================================

        // Fetch AI bot data
        // Retry fetch with backoff for connection issues
        const fetchWithRetry = async (url, maxRetries = 2, delay = 1000) => {
            for (let i = 0; i <= maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries) {
                        console.warn(`Failed to fetch ${url} after ${maxRetries + 1} attempts:`, error);
                        return null;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                }
            }
        };

        const fetchAIBotsData = async () => {
            try {
                const [sportsRes, arbitrageRes, visionRes, predictionRes, newsRes, metricsRes] = await Promise.all([
                    fetchWithRetry('/api/ai/sports-bot/status'),
                    fetch('/api/ai/arbitrage-bot/status').then(r => r.json()).catch(() => null),
                    fetch('/api/ai/computer-vision/status').then(r => r.json()).catch(() => null),
                    fetch('/api/ai/prediction-analyzer/status').then(r => r.json()).catch(() => null),
                    fetch('/api/ai/news-feed/status').then(r => r.json()).catch(() => null),
                    fetch('/api/ai/combined-metrics').then(r => r.json()).catch(() => null)
                ]);

                // Build result with guaranteed metrics structure
                const result = {
                    sports: sportsRes?.success ? sportsRes : null,
                    arbitrage: arbitrageRes?.success ? arbitrageRes : null,
                    vision: visionRes?.success ? visionRes : null,
                    prediction: predictionRes?.success ? predictionRes : null,
                    news: newsRes?.success ? newsRes : null,
                    metrics: metricsRes?.success ? metricsRes : {
                        // Default metrics if API fails
                        total_ai_bots: 4,
                        active_ai_bots: 0,
                        total_opportunities_found: 0,
                        high_confidence_opportunities: 0,
                        ai_success_rate: 0,
                        ai_cost_today: 0
                    }
                };

                return result;
            } catch (error) {
                console.error('Error fetching AI bot data:', error);
                // Return default structure instead of null
                return {
                    sports: null,
                    arbitrage: null,
                    vision: null,
                    prediction: null,
                    news: null,
                    metrics: {
                        total_ai_bots: 4,
                        active_ai_bots: 0,
                        total_opportunities_found: 0,
                        high_confidence_opportunities: 0,
                        ai_success_rate: 0,
                        ai_cost_today: 0
                    }
                };
            }
        };

        // =====================================
        // DEFAULT STATE (loading placeholders, replaced by API data)
        // =====================================
        const startingCapital = 500;
        const defaultEquityCurve = [];

        const defaultStrategies = [];

        const defaultPositions = [];

        const defaultAlerts = [];

        const defaultRecentTrades = [];

        const defaultBrokers = [
            { name: "Alpaca", status: "CONNECTING", latency: 0, buyingPower: 0, positions: 0, mode: "LIVE", color: "#22c55e" },
            { name: "Kalshi", status: "CONNECTING", latency: 0, buyingPower: 0, positions: 0, mode: "LIVE", color: "#3b82f6" },
            { name: "OANDA", status: "CONNECTING", latency: 0, buyingPower: 0, positions: 0, mode: "LIVE", color: "#f59e0b" },
        ];

        const defaultEdges = { weather: [], fed: [], sports: [] };

        const defaultGoNoGo = [
            { metric: "Trades (30d)", value: "...", threshold: ">100", status: "PENDING" },
            { metric: "Win Rate", value: "...", threshold: ">45%", status: "PENDING" },
            { metric: "Sharpe Ratio", value: "...", threshold: ">1.0", status: "PENDING" },
            { metric: "Max Drawdown", value: "...", threshold: "<15%", status: "PENDING" },
            { metric: "API Status", value: "Checking...", threshold: "All OK", status: "PENDING" },
            { metric: "Error Rate", value: "...", threshold: "<5%", status: "PENDING" },
        ];

        const defaultCircuitBreakers = [
            { name: "Daily Loss Limit", current: 0, limit: 22.50, pct: 0, status: "OK" },
            { name: "Max Drawdown", current: 0, limit: 15, pct: 0, status: "OK" },
            { name: "Position Concentration", current: 0, limit: 50, pct: 0, status: "OK" },
            { name: "Consecutive Losses", current: 0, limit: 5, pct: 0, status: "OK" },
        ];

        // =====================================
        // UTILITY COMPONENTS
        // =====================================

        const MiniSparkline = ({ data, dataKey = "v", color = "#22c55e", height = 40 }) => (
            <ResponsiveContainer width="100%" height={height}>
                <AreaChart data={data} margin={{ top: 5, right: 0, left: 0, bottom: 5 }}>
                    <defs>
                        <linearGradient id={`grad-${color.replace('#','')}`} x1="0" y1="0" x2="0" y2="1">
                            <stop offset="5%" stopColor={color} stopOpacity={0.3} />
                            <stop offset="95%" stopColor={color} stopOpacity={0} />
                        </linearGradient>
                    </defs>
                    <Area type="monotone" dataKey={dataKey} stroke={color} strokeWidth={2} fill={`url(#grad-${color.replace('#','')})`} />
                </AreaChart>
            </ResponsiveContainer>
        );

        const StatusBadge = ({ status, size = "sm" }) => {
            const styles = {
                LIVE: "bg-emerald-500/20 text-emerald-400 border-emerald-500/30",
                PAUSED: "bg-amber-500/20 text-amber-400 border-amber-500/30",
                ERROR: "bg-red-500/20 text-red-400 border-red-500/30",
                HEALTHY: "bg-emerald-500/20 text-emerald-400 border-emerald-500/30",
                CONNECTED: "bg-emerald-500/20 text-emerald-400 border-emerald-500/30",
                DISCONNECTED: "bg-red-500/20 text-red-400 border-red-500/30",
                RECONNECTING: "bg-amber-500/20 text-amber-400 border-amber-500/30",
                CONNECTING: "bg-blue-500/20 text-blue-400 border-blue-500/30",
                PENDING: "bg-slate-500/20 text-slate-400 border-slate-500/30",
                PASS: "bg-emerald-500/20 text-emerald-400",
                FAIL: "bg-red-500/20 text-red-400",
                WARNING: "bg-amber-500/20 text-amber-400",
                OK: "bg-emerald-500/20 text-emerald-400",
                APPROVED: "bg-emerald-500/20 text-emerald-400",
                VETOED: "bg-red-500/20 text-red-400",
                REDUCED: "bg-amber-500/20 text-amber-400",
                NO_CREDENTIALS: "bg-red-500/20 text-red-400 border-red-500/30",
                AUTH_FAILED: "bg-red-500/20 text-red-400 border-red-500/30",
                SLOW: "bg-amber-500/20 text-amber-400 border-amber-500/30",
            };
            const sizeClass = size === "xs" ? "px-1.5 py-0.5 text-[10px]" : "px-2 py-0.5 text-xs";
            return (
                <span className={`${sizeClass} font-semibold rounded border ${styles[status] || "bg-slate-500/20 text-slate-400"}`}>
                    {status}
                </span>
            );
        };

        const Card = ({ children, className = "", gradient = "", id }) => (
            <div id={id} className={`bg-slate-800/60 backdrop-blur border border-slate-700/50 rounded-xl ${gradient} ${className}`}>
                {children}
            </div>
        );

        // =====================================
        // HIGH RISK TOGGLE COMPONENT
        // =====================================
        const HighRiskToggle = ({ enabled, onToggle, loading }) => {
            return (
                <div className="flex items-center gap-3">
                    <span className="text-sm text-slate-400">High Risk Trades</span>
                    <button
                        onClick={onToggle}
                        disabled={loading}
                        className={`relative inline-flex h-7 w-14 items-center rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 ${
                            enabled
                                ? 'bg-red-600 hover:bg-red-500 focus:ring-red-500'
                                : 'bg-slate-600 hover:bg-slate-500 focus:ring-slate-500'
                        } ${loading ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                        title={enabled ? 'High Risk Trades ACTIVE - Click to disable' : 'High Risk Trades INACTIVE - Click to enable'}
                    >
                        <span
                            className={`inline-block h-5 w-5 transform rounded-full bg-white shadow-lg transition-transform duration-300 ${
                                enabled ? 'translate-x-8' : 'translate-x-1'
                            }`}
                        />
                        {loading && (
                            <span className="absolute inset-0 flex items-center justify-center">
                                <svg className="w-4 h-4 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                        )}
                    </button>
                    <span className={`text-xs font-bold px-2 py-1 rounded ${
                        enabled
                            ? 'bg-red-500/20 text-red-400 border border-red-500/30'
                            : 'bg-slate-700 text-slate-400 border border-slate-600'
                    }`}>
                        {enabled ? 'ACTIVE' : 'INACTIVE'}
                    </span>
                </div>
            );
        };

        // =====================================
        // HEADER COMPONENT
        // =====================================
        const Header = ({ apiStatus, lastUpdate, onKillSwitch, onRefresh, onAlertClick, alertCount, expertMode, highRiskEnabled, onToggleHighRisk, highRiskLoading }) => (
            <header className="flex flex-wrap items-center justify-between bg-slate-800/40 backdrop-blur-sm border border-slate-700/50 rounded-xl px-6 py-4">
                <div className="flex items-center gap-6">
                    {/* Mode Indicator */}
                    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg ${
                        expertMode
                            ? 'bg-red-500/20 border border-red-500/30'
                            : 'bg-emerald-500/20 border border-emerald-500/30'
                    }`}>
                        <div className={`w-2 h-2 rounded-full animate-pulse ${expertMode ? 'bg-red-400' : 'bg-emerald-400'}`} />
                        <span className={`font-semibold text-sm ${expertMode ? 'text-red-400' : 'text-emerald-400'}`}>{expertMode ? 'LIVE TRADING' : 'PAPER MODE'}</span>
                    </div>

                    <div className="h-6 w-px bg-slate-700" />

                    {/* API Status */}
                    <div className="flex items-center gap-2">
                        {apiStatus === "HEALTHY" ? (
                            <span className="text-emerald-400"><Icons.Wifi /></span>
                        ) : (
                            <span className="text-red-400"><Icons.WifiOff /></span>
                        )}
                        <span className="text-sm font-medium text-slate-300">API</span>
                        <StatusBadge status={apiStatus} />
                    </div>

                    <div className="h-6 w-px bg-slate-700" />

                    {/* Last Update */}
                    <div className="flex items-center gap-2 text-slate-400">
                        <Icons.Clock />
                        <span className="text-sm">{lastUpdate}</span>
                    </div>

                    {/* Refresh Button */}
                    <button onClick={onRefresh} className="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-slate-400 hover:text-slate-200">
                        <Icons.RefreshCw />
                    </button>
                </div>

                <div className="flex items-center gap-4">
                    {/* HIGH RISK TOGGLE - Prominent Position */}
                    <div className="px-3 py-2 bg-slate-800/80 border border-slate-700 rounded-lg">
                        <HighRiskToggle
                            enabled={highRiskEnabled}
                            onToggle={onToggleHighRisk}
                            loading={highRiskLoading}
                        />
                    </div>

                    <div className="h-8 w-px bg-slate-700" />

                    {/* Alerts Bell */}
                    <button
                        onClick={onAlertClick}
                        className="relative p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-slate-400 hover:text-slate-200"
                        title="View Alerts"
                    >
                        <Icons.Bell />
                        {alertCount > 0 && (
                            <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">
                                {alertCount}
                            </span>
                        )}
                    </button>

                    {/* Expert Mode - Always On */}
                    <div className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium bg-purple-500/20 text-purple-400 border border-purple-500/30">
                        <Icons.Settings />
                        Expert
                    </div>

                    {/* Kill Switch */}
                    <button
                        onClick={onKillSwitch}
                        className="flex items-center gap-2 px-5 py-2.5 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-lg transition-colors shadow-lg shadow-red-900/30"
                    >
                        <Icons.Zap />
                        KILL SWITCH
                    </button>
                </div>
            </header>
        );

        // =====================================
        // MOCK DATA WARNING BANNER
        // =====================================
        const MockDataBanner = ({ sources }) => {
            if (!sources || sources.length === 0) return null;

            return (
                <div className="rounded-lg border border-amber-500/50 bg-amber-500/10 p-3 flex items-center gap-3">
                    <div className="flex-shrink-0">
                        <Icons.AlertTriangle />
                    </div>
                    <div className="flex-1">
                        <p className="text-amber-400 font-semibold text-sm">
                            MOCK DATA - Dashboard showing placeholder values
                        </p>
                        <p className="text-amber-400/70 text-xs mt-0.5">
                            Affected: {sources.join(', ')}. Start trading to see real metrics.
                        </p>
                    </div>
                    <div className="flex-shrink-0 text-amber-500/50 text-xs font-mono">
                        DEMO MODE
                    </div>
                </div>
            );
        };

        // =====================================
        // KPI ROW COMPONENT
        // =====================================
        const KPIRow = ({ data, isLoading }) => {
            if (isLoading) {
                return (
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        {[...Array(5)].map((_, i) => <CardSkeleton key={i} />)}
                    </div>
                );
            }
            const kpis = [
                {
                    label: "Total P&L",
                    value: `${data.totalPnL >= 0 ? '+' : ''}$${data.totalPnL.toLocaleString()}`,
                    subtext: `vs yesterday: ${data.pnlChange >= 0 ? '+' : ''}$${data.pnlChange}`,
                    color: data.totalPnL >= 0 ? "text-emerald-400" : "text-red-400",
                    icon: Icons.DollarSign
                },
                {
                    label: "Trade Count (30d)",
                    value: data.tradeCount,
                    subtext: `${data.openPositions} open positions`,
                    color: "text-slate-100",
                    icon: Icons.Activity
                },
                {
                    label: "Win Rate",
                    value: `${data.winRate}%`,
                    subtext: `Profit Factor: ${data.profitFactor}`,
                    color: "text-slate-100",
                    icon: Icons.Percent
                },
                {
                    label: "Max Drawdown",
                    value: `$${data.drawdown}`,
                    subtext: `${data.drawdownPct}% of capital`,
                    color: "text-amber-400",
                    icon: Icons.TrendingDown
                },
                {
                    label: "Exposure",
                    value: `${data.exposure}%`,
                    subtext: `$${data.invested} / $${data.capital}`,
                    color: "text-slate-100",
                    icon: Icons.BarChart3,
                    showBar: true,
                    brokers: data.brokerExposure
                },
            ];

            return (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    {kpis.map((kpi, i) => (
                        <Card key={i} className="p-4">
                            <div className="flex items-center gap-2 text-slate-500 text-sm mb-1">
                                <kpi.icon />
                                <span>{kpi.label}</span>
                            </div>
                            <p className={`text-3xl font-bold ${kpi.color}`}>{kpi.value}</p>
                            {kpi.showBar ? (
                                <div className="mt-2">
                                    <div className="flex gap-1 h-2">
                                        {kpi.brokers.map((b, idx) => (
                                            <div
                                                key={idx}
                                                className="rounded"
                                                style={{ width: `${b.pct}%`, backgroundColor: b.color }}
                                                title={`${b.name}: ${b.pct}%`}
                                            />
                                        ))}
                                    </div>
                                    <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                                        {kpi.brokers.map((b, idx) => (
                                            <span key={idx}>{b.name}</span>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <p className="text-xs text-slate-500 mt-1">{kpi.subtext}</p>
                            )}
                        </Card>
                    ))}
                </div>
            );
        };

        // =====================================
        // GO/NO-GO PANEL
        // =====================================
        const GoNoGoPanel = ({ checks }) => {
            const hasFail = checks.some(c => c.status === "FAIL");
            const hasPending = checks.some(c => c.status === "PENDING");
            const allPass = checks.every(c => c.status === "PASS");

            let overallStatus = "PASS";
            let overallLabel = "GO";
            if (hasFail) {
                overallStatus = "FAIL";
                overallLabel = "NO-GO";
            } else if (hasPending) {
                overallStatus = "PENDING";
                overallLabel = "PENDING";
            }

            return (
                <Card className="p-4">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-sm font-semibold text-slate-300 flex items-center gap-2">
                            <Icons.Shield />
                            GO/NO-GO Validation
                        </h3>
                        <div className="flex items-center gap-2">
                            <span className={`text-sm font-semibold ${
                                overallStatus === "PASS" ? "text-emerald-400" :
                                overallStatus === "FAIL" ? "text-red-400" : "text-slate-400"
                            }`}>{overallLabel}</span>
                            <StatusBadge status={overallStatus} />
                        </div>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                        {checks.map((check, i) => (
                            <div key={i} className="flex items-center justify-between py-2 px-3 bg-slate-900/50 rounded-lg">
                                <div>
                                    <p className="text-xs text-slate-500">{check.metric}</p>
                                    <p className="text-sm font-semibold text-slate-200">{check.value}</p>
                                </div>
                                <StatusBadge status={check.status} size="xs" />
                            </div>
                        ))}
                    </div>
                </Card>
            );
        };

        // =====================================
        // STRATEGY CARD COMPONENT
        // =====================================
        const StrategyCard = ({ strategy, onPauseResume, showAI = true }) => {
            const [expanded, setExpanded] = useState(false);
            const isProfit = strategy.pnl >= 0;
            const sparkData = useMemo(() => {
                const seed = strategy.name.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
                return Array.from({ length: 15 }, (_, i) => ({
                    v: 50 + ((seed * (i + 1) * 9301 + 49297) % 233280) / 233280 * 30 + i * 2
                }));
            }, [strategy.name]);

            return (
                <Card className="p-4 hover:border-slate-600/50 transition-all">
                    <div className="flex items-center justify-between mb-3">
                        <h3 className="font-semibold text-slate-100 text-sm">{strategy.name}</h3>
                        <div className="flex items-center gap-2">
                            {strategy.status === "LIVE" && (
                                <div className="w-2 h-2 bg-emerald-400 rounded-full pulse-live" />
                            )}
                            <StatusBadge status={strategy.status} />
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <p className="text-xs text-slate-500 uppercase tracking-wide">P&L</p>
                            <p className={`text-xl font-bold ${isProfit ? 'text-emerald-400' : 'text-red-400'}`}>
                                {isProfit ? '+' : ''}${strategy.pnl.toLocaleString()}
                            </p>
                        </div>
                        <div>
                            <p className="text-xs text-slate-500 uppercase tracking-wide">Win Rate</p>
                            <p className="text-xl font-bold text-slate-100">{strategy.winRate}%</p>
                        </div>
                    </div>

                    <div className="mb-3">
                        <div className="flex justify-between text-xs text-slate-500 mb-1">
                            <span>Drawdown: ${strategy.drawdown}</span>
                            <span>{strategy.trades} trades</span>
                        </div>
                        <MiniSparkline data={sparkData} color={isProfit ? "#22c55e" : "#f59e0b"} height={30} />
                    </div>

                    {showAI && (
                        <div className="mb-3 p-2 bg-indigo-900/30 border border-indigo-700/30 rounded-lg">
                            <div className="flex items-center justify-between mb-1">
                                <span className="text-xs text-indigo-400 flex items-center gap-1">
                                    <Icons.Brain />
                                    AI Decision
                                </span>
                                <StatusBadge status={strategy.aiDecision} size="xs" />
                            </div>
                            <p className="text-xs text-slate-400 line-clamp-2">{strategy.aiReason}</p>
                        </div>
                    )}

                    <div className="flex items-center justify-between pt-3 border-t border-slate-700/50">
                        <div className="min-w-0 flex-1 mr-2">
                            <p className="text-xs text-slate-500">Last Signal</p>
                            <p className="text-sm text-slate-300 truncate" title={`${strategy.lastSignal.type} ${strategy.lastSignal.symbol}`}>
                                <span className={strategy.lastSignal.type === "BUY" ? "text-emerald-400" : strategy.lastSignal.type === "SELL" ? "text-red-400" : strategy.lastSignal.type === "ERROR" || strategy.lastSignal.type === "ASYNC_ERROR" ? "text-amber-400" : "text-slate-400"}>
                                    {strategy.lastSignal.type}
                                </span>
                                {strategy.lastSignal.symbol ? ` ${strategy.lastSignal.symbol}` : ''} <span className="text-slate-500">{strategy.lastSignal.time}</span>
                            </p>
                        </div>
                        <button
                            onClick={() => onPauseResume(strategy.id)}
                            className="px-3 py-1.5 text-xs font-medium bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg transition-colors"
                        >
                            {strategy.status === 'LIVE' ? 'Pause' : 'Resume'}
                        </button>
                    </div>
                </Card>
            );
        };

        // =====================================
        // EQUITY CURVE PANEL
        // =====================================
        const EquityCurvePanel = ({ data }) => {
            const [timeframe, setTimeframe] = usePersistedState('equity_tf', '30D');
            const [showBenchmarks, setShowBenchmarks] = useState(true);

            return (
                <Card className="p-5">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-semibold text-slate-300 flex items-center gap-2">
                            <Icons.TrendingUp />
                            Equity Curve
                        </h2>
                        <div className="flex items-center gap-2">
                            {["1D", "7D", "30D", "90D", "1Y", "ALL"].map(tf => (
                                <button
                                    key={tf}
                                    onClick={() => setTimeframe(tf)}
                                    className={`px-3 py-1 text-xs font-medium rounded transition-colors ${
                                        timeframe === tf
                                            ? "bg-blue-500/20 text-blue-400"
                                            : "bg-slate-700 text-slate-400 hover:text-slate-200"
                                    }`}
                                >
                                    {tf}
                                </button>
                            ))}
                            <button
                                onClick={() => setShowBenchmarks(!showBenchmarks)}
                                className={`px-3 py-1 text-xs font-medium rounded transition-colors ${
                                    showBenchmarks ? "bg-purple-500/20 text-purple-400" : "bg-slate-700 text-slate-400"
                                }`}
                            >
                                Benchmarks
                            </button>
                        </div>
                    </div>

                    {data.length === 0 ? (
                        <div className="flex items-center justify-center h-[220px] text-slate-500">
                            <div className="text-center">
                                <Icons.TrendingUp />
                                <p className="text-sm mt-2">No equity data yet</p>
                                <p className="text-xs mt-1">Chart will populate as trades are recorded</p>
                            </div>
                        </div>
                    ) : (
                        <>
                            <ResponsiveContainer width="100%" height={220}>
                                <AreaChart data={data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                                    <defs>
                                        <linearGradient id="equityGradient" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#22c55e" stopOpacity={0.3} />
                                            <stop offset="95%" stopColor="#22c55e" stopOpacity={0} />
                                        </linearGradient>
                                    </defs>
                                    <XAxis dataKey="day" axisLine={false} tickLine={false} tick={{ fill: '#64748b', fontSize: 11 }} />
                                    <YAxis axisLine={false} tickLine={false} tick={{ fill: '#64748b', fontSize: 11 }} domain={['dataMin - 20', 'dataMax + 20']} />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                                        labelStyle={{ color: '#94a3b8' }}
                                    />
                                    <Area type="monotone" dataKey="equity" stroke="#22c55e" strokeWidth={2} fill="url(#equityGradient)" name="Portfolio" />
                                    {showBenchmarks && (
                                        <>
                                            <Line type="monotone" dataKey="spy" stroke="#64748b" strokeWidth={1} strokeDasharray="5 5" dot={false} name="SPY" />
                                            <Line type="monotone" dataKey="btc" stroke="#f59e0b" strokeWidth={1} strokeDasharray="5 5" dot={false} name="BTC" />
                                        </>
                                    )}
                                </AreaChart>
                            </ResponsiveContainer>

                            {showBenchmarks && (
                                <div className="flex items-center justify-center gap-6 mt-2 text-xs">
                                    <span className="flex items-center gap-1"><span className="w-3 h-0.5 bg-emerald-500" /> Portfolio</span>
                                    <span className="flex items-center gap-1"><span className="w-3 h-0.5 bg-slate-500 border-dashed" /> SPY</span>
                                    <span className="flex items-center gap-1"><span className="w-3 h-0.5 bg-amber-500 border-dashed" /> BTC</span>
                                </div>
                            )}
                        </>
                    )}
                </Card>
            );
        };

        // =====================================
        // POSITIONS PANEL
        // =====================================
        const PositionsPanel = ({ positions, onClose, onCloseAll }) => {
            const totalPnL = positions.reduce((sum, p) => sum + (p.pnl || 0), 0);

            return (
                <Card className="p-5">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-semibold text-slate-300 flex items-center gap-2">
                            <Icons.Target />
                            Active Positions ({positions.length})
                        </h2>
                        {positions.length > 0 && (
                            <button
                                onClick={onCloseAll}
                                className="px-3 py-1.5 text-xs font-medium bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-colors"
                            >
                                Close All
                            </button>
                        )}
                    </div>

                    {positions.length === 0 ? (
                        <div className="text-center py-12 text-slate-500">
                            <Icons.Target className="w-10 h-10 mx-auto mb-3 opacity-50" />
                            <p className="text-lg">No open positions</p>
                            <p className="text-sm mt-1">Positions will appear here when trades are executed</p>
                        </div>
                    ) : (
                        <>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead>
                                        <tr className="text-left text-xs text-slate-500 uppercase tracking-wide border-b border-slate-700/50">
                                            <th className="pb-3 px-3">Symbol</th>
                                            <th className="pb-3 px-3">Broker</th>
                                            <th className="pb-3 px-3">Strategy</th>
                                            <th className="pb-3 px-3">Side</th>
                                            <th className="pb-3 px-3">Qty</th>
                                            <th className="pb-3 px-3">Entry</th>
                                            <th className="pb-3 px-3">Current</th>
                                            <th className="pb-3 px-3">P&L</th>
                                            <th className="pb-3 px-3">Age</th>
                                            <th className="pb-3 px-3"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {positions.map((pos, i) => (
                                            <tr key={i} className="border-b border-slate-700/30 table-row-hover transition-colors">
                                                <td className="py-3 px-3">
                                                    <span className="font-semibold text-slate-100">{pos.symbol}</span>
                                                </td>
                                                <td className="py-3 px-3 text-slate-400 text-sm">{pos.broker}</td>
                                                <td className="py-3 px-3 text-slate-400 text-sm">{pos.strategy}</td>
                                                <td className="py-3 px-3">
                                                    <span className={`px-2 py-0.5 text-xs font-medium rounded ${
                                                        ['LONG', 'YES'].includes(pos.side) ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'
                                                    }`}>
                                                        {pos.side}
                                                    </span>
                                                </td>
                                                <td className="py-3 px-3 text-slate-300 font-mono text-sm">{pos.qty}</td>
                                                <td className="py-3 px-3 text-slate-300 font-mono text-sm">${(pos.entryPrice || 0).toFixed(2)}</td>
                                                <td className="py-3 px-3 text-slate-300 font-mono text-sm">${(pos.currentPrice || 0).toFixed(2)}</td>
                                                <td className={`py-3 px-3 font-semibold ${(pos.pnl || 0) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                    {(pos.pnl || 0) >= 0 ? '+' : ''}${(pos.pnl || 0).toFixed(2)}
                                                    <span className="text-xs text-slate-500 ml-1">({(pos.pnlPct || 0).toFixed(2)}%)</span>
                                                </td>
                                                <td className="py-3 px-3 text-slate-500 text-sm">{pos.age}</td>
                                                <td className="py-3 px-3">
                                                    <button
                                                        onClick={() => onClose(pos)}
                                                        className="px-2 py-1 text-xs bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded transition-colors"
                                                    >
                                                        Close
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div className="flex items-center justify-between mt-4 pt-4 border-t border-slate-700/50 text-sm">
                                <span className="text-slate-400">Total Unrealized:
                                    <span className={`font-semibold ml-1 ${totalPnL >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                        {totalPnL >= 0 ? '+' : ''}${totalPnL.toFixed(2)}
                                    </span>
                                </span>
                            </div>
                        </>
                    )}
                </Card>
            );
        };

        // =====================================
        // BROKER HEALTH PANEL
        // =====================================
        const BrokerHealthPanel = ({ brokers }) => (
            <Card className="p-4">
                <h3 className="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                    <Icons.Activity />
                    Broker Health
                </h3>
                <div className="space-y-3">
                    {brokers.map((broker, i) => (
                        <div key={i} className="flex items-center justify-between py-2 px-3 bg-slate-900/50 rounded-lg">
                            <div className="flex items-center gap-3">
                                <div className="w-2 h-2 rounded-full" style={{ backgroundColor: broker.color }} />
                                <div>
                                    <p className="font-semibold text-sm text-slate-200">{broker.name}</p>
                                    <p className="text-xs text-slate-500">{broker.mode}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4 text-xs">
                                <div className="text-right">
                                    <p className="text-slate-500">Latency</p>
                                    <p className={`font-mono ${broker.latency < 100 ? 'text-emerald-400' : broker.latency < 200 ? 'text-amber-400' : 'text-red-400'}`}>
                                        {broker.latency}ms
                                    </p>
                                </div>
                                <div className="text-right">
                                    <p className="text-slate-500">Buying Power</p>
                                    <p className="text-slate-200 font-semibold">${(Number(broker.buyingPower) || 0).toFixed(2)}</p>
                                </div>
                                <StatusBadge status={broker.status} size="xs" />
                            </div>
                        </div>
                    ))}
                </div>
            </Card>
        );

        // =====================================
        // AI STATUS PANEL
        // =====================================
        const AIStatusPanel = ({ data, aiBotsData }) => {
            // Safely extract metrics with defaults
            const metrics = aiBotsData?.metrics || {};
            const hasMetrics = aiBotsData?.metrics && typeof aiBotsData.metrics === 'object';

            return (
                <Card className="p-4 bg-gradient-to-br from-indigo-900/40 to-slate-800/60 border-indigo-700/30">
                    <h3 className="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                        <Icons.Brain />
                        AI Bots Status
                    </h3>
                    <div className="space-y-3">
                        {hasMetrics ? (
                            <>
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-400 text-sm">Active Bots</span>
                                    <span className="px-2 py-1 bg-emerald-500/20 text-emerald-400 text-xs font-semibold rounded">
                                        {metrics.active_ai_bots || 0}/{metrics.total_ai_bots || 4}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-400 text-sm">Opportunities Found</span>
                                    <span className="text-blue-400 font-semibold">{metrics.total_opportunities_found || 0}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-400 text-sm">High Confidence</span>
                                    <span className="text-emerald-400 font-semibold">{metrics.high_confidence_opportunities || 0}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-400 text-sm">AI Success Rate</span>
                                    <span className="text-slate-200 font-semibold">{((metrics.ai_success_rate || 0) * 100).toFixed(1)}%</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-400 text-sm">AI Cost Today</span>
                                    <span className="text-slate-300">${(metrics.ai_cost_today || 0).toFixed(2)}</span>
                                </div>
                            </>
                        ) : (
                        <>
                            <div className="flex justify-between items-center">
                                <span className="text-slate-400 text-sm">Current Regime</span>
                                <span className="px-2 py-1 bg-amber-500/20 text-amber-400 text-xs font-semibold rounded">{data.regime}</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-slate-400 text-sm">Confidence</span>
                                <span className="text-slate-200 font-semibold">{data.regimeConfidence}%</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-slate-400 text-sm">Sentiment</span>
                                <span className={`font-semibold ${data.sentiment > 0 ? 'text-emerald-400' : data.sentiment < 0 ? 'text-red-400' : 'text-slate-400'}`}>
                                    {data.sentiment > 0 ? '+' : ''}{data.sentiment.toFixed(2)}
                                    <span className="text-xs text-slate-500 ml-1">({data.sentimentLabel})</span>
                                </span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-slate-400 text-sm">Veto Rate Today</span>
                                <span className="text-slate-200 font-semibold">{data.vetoRate}%</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-slate-400 text-sm">Active Edges</span>
                                <span className="text-blue-400 font-semibold">{data.activeEdges} found</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-slate-400 text-sm">AI Cost Today</span>
                                <span className="text-slate-300">${data.aiCost.toFixed(2)}</span>
                            </div>
                        </>
                    )}
                    </div>
                </Card>
            );
        };

        // =====================================
        // ALERTS PANEL
        // =====================================
        const AlertsPanel = ({ alerts, id }) => {
            const severityStyles = {
                critical: { border: "border-l-red-500", icon: Icons.AlertTriangle, iconColor: "text-red-400" },
                warning: { border: "border-l-amber-500", icon: Icons.AlertCircle, iconColor: "text-amber-400" },
                info: { border: "border-l-blue-500", icon: Icons.Info, iconColor: "text-blue-400" },
            };

            return (
                <Card className="p-4" id={id}>
                    <h3 className="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                        <Icons.Bell />
                        Alerts ({alerts.length})
                    </h3>
                    <div className="space-y-2 max-h-64 overflow-y-auto">
                        {alerts.length === 0 ? (
                            <p className="text-sm text-slate-500 text-center py-4">No alerts</p>
                        ) : alerts.map((alert) => {
                            const style = severityStyles[alert.severity] || severityStyles.info;
                            const IconComponent = style.icon;
                            return (
                                <div key={alert.id} className={`flex items-start gap-3 p-3 bg-slate-900/50 border-l-2 ${style.border} rounded-r`}>
                                    <span className={style.iconColor}><IconComponent /></span>
                                    <div className="flex-1 min-w-0">
                                        <p className="text-sm text-slate-200">{alert.message}</p>
                                        <p className="text-xs text-slate-500 mt-1">{alert.source}  {alert.time}</p>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </Card>
            );
        };

        // =====================================
        // RECENT TRADES PANEL
        // =====================================
        const RecentTradesPanel = ({ trades }) => (
            <Card className="p-4">
                <h3 className="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                    <Icons.List />
                    Recent Trades ({trades.length})
                </h3>
                {trades.length === 0 ? (
                    <div className="text-center py-8 text-slate-500">
                        <Icons.List className="w-8 h-8 mx-auto mb-2 opacity-50" />
                        <p>No trades yet</p>
                        <p className="text-xs mt-1">Trades will appear here when executed</p>
                    </div>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="w-full">
                            <thead>
                                <tr className="text-left text-[10px] text-slate-500 uppercase tracking-wide">
                                    <th className="pb-2">Time</th>
                                    <th className="pb-2">Symbol</th>
                                    <th className="pb-2">Side</th>
                                    <th className="pb-2">Fill</th>
                                    <th className="pb-2">Slip</th>
                                    <th className="pb-2">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {trades.map((trade) => (
                                    <tr key={trade.id} className="border-t border-slate-700/30 text-xs">
                                        <td className="py-2 text-slate-500">{trade.time}</td>
                                        <td className="py-2 text-slate-200 font-medium">{trade.symbol}</td>
                                        <td className="py-2">
                                            <span className={["BUY", "YES", "LONG"].includes(trade.side) ? "text-emerald-400" : "text-red-400"}>
                                                {trade.side}
                                            </span>
                                        </td>
                                        <td className="py-2 text-slate-300 font-mono">${trade.fillPrice || '0.00'}</td>
                                        <td className={`py-2 font-mono ${(trade.slippage || 0) > 0 ? 'text-red-400' : (trade.slippage || 0) < 0 ? 'text-emerald-400' : 'text-slate-500'}`}>
                                            {(trade.slippage || 0) > 0 ? '+' : ''}{trade.slippage || 0}
                                        </td>
                                        <td className="py-2">
                                            <StatusBadge status={trade.status === "FILLED" ? "PASS" : "WARNING"} size="xs" />
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </Card>
        );

        // =====================================
        // CIRCUIT BREAKERS PANEL
        // =====================================
        const CircuitBreakersPanel = ({ breakers }) => {
            // Format values based on breaker type
            const formatValue = (breaker, value) => {
                const name = breaker.name.toLowerCase();
                if (name.includes('loss limit')) {
                    return `$${value.toFixed(2)}`;
                } else if (name.includes('drawdown') || name.includes('concentration')) {
                    return `${value}%`;
                } else if (name.includes('consecutive')) {
                    return `${value}`;
                }
                return `${value}`;
            };

            return (
                <Card className="p-4">
                    <h3 className="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                        <Icons.Shield />
                        Circuit Breakers
                    </h3>
                    <div className="space-y-3">
                        {breakers.map((breaker, i) => (
                            <div key={i}>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-slate-400">{breaker.name}</span>
                                    <span className={breaker.status === "WARNING" ? "text-amber-400" : "text-slate-300"}>
                                        {formatValue(breaker, breaker.current)} / {formatValue(breaker, breaker.limit)}
                                    </span>
                                </div>
                                <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div
                                        className={`h-full rounded-full transition-all ${
                                            breaker.pct >= 80 ? 'bg-red-500' : breaker.pct >= 60 ? 'bg-amber-500' : 'bg-emerald-500'
                                        }`}
                                        style={{ width: `${breaker.pct}%` }}
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                </Card>
            );
        };

        // =====================================
        // AI BOTS PANEL
        // =====================================
        const AIBotsPanel = ({ aiBotsData }) => {
            const [activeTab, setActiveTab] = usePersistedState('ai_tab', 'sports');

            if (!aiBotsData) {
                return (
                    <Card className="p-4">
                        <h3 className="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                            <Icons.Brain />
                            AI Trading Bots
                        </h3>
                        <div className="text-center py-8 text-slate-500">
                            <Icons.Brain className="w-8 h-8 mx-auto mb-2 opacity-50" />
                            <p>Loading AI bot data...</p>
                        </div>
                    </Card>
                );
            }

            return (
                <Card className="p-4 bg-gradient-to-br from-purple-900/20 to-slate-800/60 border-purple-700/30">
                    <h3 className="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                        <Icons.Brain />
                        AI Trading Bots
                    </h3>

                    <div className="flex gap-2 mb-4">
                        {[
                            { key: "sports", label: "Sports AI", icon: Icons.Trophy },
                            { key: "arbitrage", label: "Arbitrage", icon: Icons.DollarSign },
                            { key: "vision", label: "Vision", icon: Icons.Eye },
                            { key: "prediction", label: "Prediction", icon: Icons.Brain },
                        ].map(tab => (
                            <button
                                key={tab.key}
                                onClick={() => setActiveTab(tab.key)}
                                className={`flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded transition-colors ${
                                    activeTab === tab.key
                                        ? "bg-purple-500/20 text-purple-400"
                                        : "bg-slate-700 text-slate-400 hover:text-slate-200"
                                }`}
                            >
                                <tab.icon />
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {activeTab === "sports" && aiBotsData.sports && (
                        <div className="space-y-3">
                            <div className="flex justify-between items-center">
                                <span className="text-sm font-medium text-slate-200">Sports AI Bot</span>
                                <StatusBadge status={aiBotsData.sports.status === 'success' ? 'LIVE' : 'ERROR'} size="xs" />
                            </div>
                            <div className="text-xs text-slate-400 mb-2">
                                Last run: {new Date(aiBotsData.sports.last_run).toLocaleTimeString()}
                            </div>

                            {aiBotsData.sports.opportunities?.length > 0 ? (
                                <div className="space-y-2 max-h-32 overflow-y-auto">
                                    {aiBotsData.sports.opportunities.slice(0, 3).map((opp, i) => (
                                        <div key={i} className="p-2 bg-slate-900/50 rounded text-xs">
                                            <div className="font-medium text-slate-200">{opp.player}</div>
                                            <div className="text-slate-400">{opp.prop} - {opp.direction}</div>
                                            <div className="flex gap-2 mt-1">
                                                <span className="text-emerald-400">Conf: {opp.confidence}</span>
                                                <span className="text-blue-400">EV: {opp.expected_value}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-4 text-slate-500 text-xs">
                                    No opportunities found
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === "arbitrage" && aiBotsData.arbitrage && (
                        <div className="space-y-3">
                            <div className="flex justify-between items-center">
                                <span className="text-sm font-medium text-slate-200">Cross-Market Arbitrage</span>
                                <StatusBadge status={aiBotsData.arbitrage.status === 'active' ? 'LIVE' : 'ERROR'} size="xs" />
                            </div>
                            <div className="text-xs text-slate-400 mb-2">
                                Found {aiBotsData.arbitrage.total_opportunities || 0} opportunities
                            </div>

                            {aiBotsData.arbitrage.opportunities?.length > 0 ? (
                                <div className="space-y-2 max-h-32 overflow-y-auto">
                                    {aiBotsData.arbitrage.opportunities.slice(0, 3).map((opp, i) => (
                                        <div key={i} className="p-2 bg-slate-900/50 rounded text-xs">
                                            <div className="font-medium text-slate-200">{opp.market_title}</div>
                                            <div className="text-slate-400">{opp.primary_platform}  {opp.secondary_platform}</div>
                                            <div className="flex gap-2 mt-1">
                                                <span className="text-emerald-400">+{opp.expected_profit}%</span>
                                                <span className="text-amber-400">{opp.risk_level}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-4 text-slate-500 text-xs">
                                    No arbitrage opportunities
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === "vision" && aiBotsData.vision && (
                        <div className="space-y-3">
                            <div className="flex justify-between items-center">
                                <span className="text-sm font-medium text-slate-200">Computer Vision</span>
                                <StatusBadge status={aiBotsData.vision.status === 'monitoring' ? 'LIVE' : 'ERROR'} size="xs" />
                            </div>
                            <div className="text-xs text-slate-400 mb-2">
                                Windows MCP: {aiBotsData.vision.windows_mcp_available ? 'Available' : 'Unavailable'}
                            </div>

                            {aiBotsData.vision.recent_activities?.length > 0 ? (
                                <div className="space-y-2 max-h-32 overflow-y-auto">
                                    {aiBotsData.vision.recent_activities.slice(0, 3).map((activity, i) => (
                                        <div key={i} className="p-2 bg-slate-900/50 rounded text-xs">
                                            <div className="font-medium text-slate-200">{activity.action}</div>
                                            <div className="text-slate-400">Broker: {activity.broker}</div>
                                            <div className="text-slate-500">{new Date(activity.time).toLocaleTimeString()}</div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-4 text-slate-500 text-xs">
                                    No recent activities
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === "prediction" && aiBotsData.prediction && (
                        <div className="space-y-3">
                            <div className="flex justify-between items-center">
                                <span className="text-sm font-medium text-slate-200">AI Prediction Analyzer</span>
                                <StatusBadge status={aiBotsData.prediction.status === 'active' ? 'LIVE' : 'STANDBY'} size="xs" />
                            </div>
                            <div className="text-xs text-slate-400 mb-2">
                                Ollama: {aiBotsData.prediction.ollama_available ? 'Connected' : 'Offline'}
                            </div>

                            {aiBotsData.prediction.recent_predictions?.length > 0 ? (
                                <div className="space-y-2 max-h-32 overflow-y-auto">
                                    {aiBotsData.prediction.recent_predictions.slice(0, 3).map((pred, i) => (
                                        <div key={i} className="p-2 bg-slate-900/50 rounded text-xs">
                                            <div className="font-medium text-slate-200">{pred.market}</div>
                                            <div className="text-slate-400">Prediction: {pred.ai_prediction}</div>
                                            <div className="text-emerald-400">Confidence: {pred.confidence}%</div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-4 text-slate-500 text-xs">
                                    No recent predictions
                                </div>
                            )}
                        </div>
                    )}
                </Card>
            );
        };

        // =====================================
        // NEWS FEED PANEL
        // =====================================
        const NewsFeedPanel = ({ newsData }) => (
            <Card className="p-4">
                <h3 className="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                    <Icons.Info />
                    News Feed Health
                </h3>
                {newsData ? (
                    <div className="space-y-3">
                        <div className="flex justify-between items-center">
                            <span className="text-slate-400 text-sm">Overall Health</span>
                            <StatusBadge status={newsData.overall_health === 'healthy' ? 'HEALTHY' : 'WARNING'} size="xs" />
                        </div>
                        <div className="space-y-2">
                            {newsData.sources?.slice(0, 4).map((source, i) => (
                                <div key={i} className="flex justify-between items-center py-1">
                                    <div>
                                        <p className="text-xs font-medium text-slate-200">{source.name}</p>
                                        <p className="text-xs text-slate-500">{source.articles_today} articles</p>
                                    </div>
                                    <div className="text-right">
                                        <StatusBadge status={source.status === 'healthy' ? 'OK' : 'ERROR'} size="xs" />
                                        <p className="text-xs text-slate-400 mt-1">{(source.relevance_score * 100).toFixed(0)}%</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="border-t border-slate-700 pt-2 text-xs text-slate-400">
                            Total articles today: {newsData.summary?.total_articles_today || 0}
                        </div>
                    </div>
                ) : (
                    <div className="text-center py-6 text-slate-500">
                        <Icons.Info className="w-6 h-6 mx-auto mb-2 opacity-50" />
                        <p className="text-sm">Loading news feed status...</p>
                    </div>
                )}
            </Card>
        );

        // =====================================
        // EDGE TABLES PANEL (Expert Mode)
        // =====================================
        const EdgeTablesPanel = ({ edges }) => {
            const [activeTab, setActiveTab] = usePersistedState('edge_tab', 'weather');

            return (
                <Card className="p-4 bg-gradient-to-br from-emerald-900/20 to-slate-800/60 border-emerald-700/30">
                    <h3 className="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                        <Icons.Target />
                        Edge Tables
                    </h3>

                    <div className="flex gap-2 mb-4">
                        {[
                            { key: "weather", label: "Weather", icon: Icons.Cloud },
                            { key: "fed", label: "Fed", icon: Icons.Building },
                            { key: "sports", label: "Sports", icon: Icons.Trophy },
                        ].map(tab => (
                            <button
                                key={tab.key}
                                onClick={() => setActiveTab(tab.key)}
                                className={`flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded transition-colors ${
                                    activeTab === tab.key
                                        ? "bg-emerald-500/20 text-emerald-400"
                                        : "bg-slate-700 text-slate-400 hover:text-slate-200"
                                }`}
                            >
                                <tab.icon />
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {activeTab === "weather" && (
                        <div className="space-y-2">
                            {(!edges.weather || edges.weather.length === 0) && <p className="text-xs text-slate-500 text-center py-4">No weather edges detected</p>}
                            {(edges.weather || []).map((edge, i) => (
                                <div key={i} className="p-3 bg-slate-900/50 rounded-lg">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="font-medium text-sm text-slate-200">{edge.market}</span>
                                        <span className={`px-2 py-0.5 text-[10px] font-semibold rounded ${
                                            edge.status === "TRADED" ? "bg-emerald-500/20 text-emerald-400" :
                                            edge.status === "MONITORING" ? "bg-amber-500/20 text-amber-400" :
                                            "bg-slate-500/20 text-slate-400"
                                        }`}>
                                            {edge.status}
                                        </span>
                                    </div>
                                    <div className="flex gap-4 text-xs">
                                        <span className="text-slate-400">NWS: <span className="text-slate-200">{edge.nws}%</span></span>
                                        <span className="text-slate-400">Kalshi: <span className="text-slate-200">{edge.kalshi}%</span></span>
                                        <span className={`font-semibold ${edge.edge > 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                            Edge: {edge.edge > 0 ? '+' : ''}{edge.edge}%
                                        </span>
                                        <span className={`${
                                            edge.confidence === "HIGH" ? "text-emerald-400" :
                                            edge.confidence === "MEDIUM" ? "text-amber-400" : "text-slate-500"
                                        }`}>
                                            {edge.confidence}
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {activeTab === "fed" && (
                        <div className="space-y-2">
                            {(!edges.fed || edges.fed.length === 0) && <p className="text-xs text-slate-500 text-center py-4">No Fed edges detected</p>}
                            {(edges.fed || []).map((item, i) => (
                                <div key={i} className="flex items-center justify-between p-2 bg-slate-900/50 rounded">
                                    <span className="text-sm text-slate-200">{item.outcome}</span>
                                    <div className="flex gap-4 text-xs">
                                        <span className="text-slate-400">Our: <span className="text-slate-200">{item.ourEst}%</span></span>
                                        <span className="text-slate-400">Mkt: <span className="text-slate-200">{item.market}%</span></span>
                                        <span className={`font-semibold ${item.edge > 0 ? 'text-emerald-400' : item.edge < 0 ? 'text-red-400' : 'text-slate-500'}`}>
                                            {item.edge > 0 ? '+' : ''}{item.edge}%
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {activeTab === "sports" && (
                        <div className="space-y-2">
                            {(!edges.sports || edges.sports.length === 0) && <p className="text-xs text-slate-500 text-center py-4">No sports edges detected</p>}
                            {(edges.sports || []).map((game, i) => (
                                <div key={i} className="p-3 bg-slate-900/50 rounded-lg">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="font-medium text-sm text-slate-200">{game.game}</span>
                                        <span className="text-xs text-slate-500">{game.time}</span>
                                    </div>
                                    <div className="flex gap-4 text-xs">
                                        <span className="text-slate-400">538: <span className="text-slate-200">{game.model}%</span></span>
                                        <span className="text-slate-400">Kalshi: <span className="text-slate-200">{game.kalshi}%</span></span>
                                        <span className={`font-semibold ${game.edge > 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                            Edge: {game.edge > 0 ? '+' : ''}{game.edge}%
                                        </span>
                                        <span className={`px-2 py-0.5 text-[10px] font-semibold rounded ${
                                            game.status === "BET PLACED" ? "bg-emerald-500/20 text-emerald-400" : "bg-amber-500/20 text-amber-400"
                                        }`}>
                                            {game.status}
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </Card>
            );
        };

        // =====================================
        // AI PERFORMANCE CHARTS PANEL
        // =====================================
        const AIPerformanceChartsPanel = ({ aiBotsData }) => {
            const [chartType, setChartType] = usePersistedState('ai_chart', 'overview');

            // Mock data for charts since we're in development
            const aiPerformanceData = [
                { day: 1, sports: 0, arbitrage: 0, vision: 0, prediction: 0 },
                { day: 2, sports: 2, arbitrage: 1, vision: 0, prediction: 1 },
                { day: 3, sports: 4, arbitrage: 3, vision: 1, prediction: 2 },
                { day: 4, sports: 3, arbitrage: 5, vision: 2, prediction: 3 },
                { day: 5, sports: 6, arbitrage: 4, vision: 1, prediction: 4 },
                { day: 6, sports: 8, arbitrage: 7, vision: 3, prediction: 5 },
                { day: 7, sports: 5, arbitrage: 6, vision: 4, prediction: 6 }
            ];

            const aiSuccessRates = [
                { name: 'Sports AI', rate: 75, trades: 24 },
                { name: 'Arbitrage', rate: 85, trades: 18 },
                { name: 'Vision', rate: 60, trades: 8 },
                { name: 'Prediction', rate: 70, trades: 12 }
            ];

            const opportunityDistribution = [
                { name: 'Sports', value: 35, color: '#22c55e' },
                { name: 'Arbitrage', value: 30, color: '#3b82f6' },
                { name: 'Prediction', value: 20, color: '#8b5cf6' },
                { name: 'Vision', value: 15, color: '#f59e0b' }
            ];

            return (
                <Card className="p-5 bg-gradient-to-br from-violet-900/20 to-slate-800/60 border-violet-700/30">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-semibold text-slate-300 flex items-center gap-2">
                            <Icons.BarChart3 />
                            AI Performance Analytics
                        </h2>
                        <div className="flex items-center gap-2">
                            {["overview", "success", "distribution"].map(type => (
                                <button
                                    key={type}
                                    onClick={() => setChartType(type)}
                                    className={`px-3 py-1 text-xs font-medium rounded transition-colors ${
                                        chartType === type
                                            ? "bg-violet-500/20 text-violet-400"
                                            : "bg-slate-700 text-slate-400 hover:text-slate-200"
                                    }`}
                                >
                                    {type.charAt(0).toUpperCase() + type.slice(1)}
                                </button>
                            ))}
                        </div>
                    </div>

                    {chartType === "overview" && (
                        <div className="space-y-4">
                            <div className="h-48">
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={aiPerformanceData}>
                                        <defs>
                                            <linearGradient id="sportsGradient" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#22c55e" stopOpacity={0.3} />
                                                <stop offset="95%" stopColor="#22c55e" stopOpacity={0} />
                                            </linearGradient>
                                            <linearGradient id="arbitrageGradient" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3} />
                                                <stop offset="95%" stopColor="#3b82f6" stopOpacity={0} />
                                            </linearGradient>
                                            <linearGradient id="visionGradient" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#f59e0b" stopOpacity={0.3} />
                                                <stop offset="95%" stopColor="#f59e0b" stopOpacity={0} />
                                            </linearGradient>
                                            <linearGradient id="predictionGradient" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#8b5cf6" stopOpacity={0.3} />
                                                <stop offset="95%" stopColor="#8b5cf6" stopOpacity={0} />
                                            </linearGradient>
                                        </defs>
                                        <XAxis dataKey="day" axisLine={false} tickLine={false} tick={{ fill: '#64748b', fontSize: 11 }} />
                                        <YAxis axisLine={false} tickLine={false} tick={{ fill: '#64748b', fontSize: 11 }} />
                                        <Tooltip
                                            contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                                            labelStyle={{ color: '#94a3b8' }}
                                        />
                                        <Area type="monotone" dataKey="sports" stackId="1" stroke="#22c55e" fill="url(#sportsGradient)" name="Sports AI" />
                                        <Area type="monotone" dataKey="arbitrage" stackId="1" stroke="#3b82f6" fill="url(#arbitrageGradient)" name="Arbitrage" />
                                        <Area type="monotone" dataKey="vision" stackId="1" stroke="#f59e0b" fill="url(#visionGradient)" name="Vision" />
                                        <Area type="monotone" dataKey="prediction" stackId="1" stroke="#8b5cf6" fill="url(#predictionGradient)" name="Prediction" />
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="grid grid-cols-4 gap-4 text-xs">
                                <div className="text-center">
                                    <div className="w-3 h-3 bg-emerald-500 rounded mx-auto mb-1"></div>
                                    <div className="text-emerald-400 font-medium">Sports AI</div>
                                    <div className="text-slate-500">24 opportunities</div>
                                </div>
                                <div className="text-center">
                                    <div className="w-3 h-3 bg-blue-500 rounded mx-auto mb-1"></div>
                                    <div className="text-blue-400 font-medium">Arbitrage</div>
                                    <div className="text-slate-500">18 opportunities</div>
                                </div>
                                <div className="text-center">
                                    <div className="w-3 h-3 bg-amber-500 rounded mx-auto mb-1"></div>
                                    <div className="text-amber-400 font-medium">Vision</div>
                                    <div className="text-slate-500">8 opportunities</div>
                                </div>
                                <div className="text-center">
                                    <div className="w-3 h-3 bg-violet-500 rounded mx-auto mb-1"></div>
                                    <div className="text-violet-400 font-medium">Prediction</div>
                                    <div className="text-slate-500">12 opportunities</div>
                                </div>
                            </div>
                        </div>
                    )}

                    {chartType === "success" && (
                        <div className="space-y-4">
                            <div className="h-48">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={aiSuccessRates}>
                                        <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fill: '#64748b', fontSize: 10 }} />
                                        <YAxis axisLine={false} tickLine={false} tick={{ fill: '#64748b', fontSize: 11 }} domain={[0, 100]} />
                                        <Tooltip
                                            contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                                            labelStyle={{ color: '#94a3b8' }}
                                            formatter={(value, name) => [`${value}%`, 'Success Rate']}
                                        />
                                        <Bar dataKey="rate" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                {aiSuccessRates.map((bot, i) => (
                                    <div key={i} className="p-3 bg-slate-900/50 rounded-lg">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-sm font-medium text-slate-200">{bot.name}</span>
                                            <span className={`text-sm font-bold ${
                                                bot.rate >= 80 ? 'text-emerald-400' :
                                                bot.rate >= 60 ? 'text-amber-400' : 'text-red-400'
                                            }`}>
                                                {bot.rate}%
                                            </span>
                                        </div>
                                        <div className="w-full bg-slate-700 rounded-full h-2">
                                            <div
                                                className={`h-2 rounded-full ${
                                                    bot.rate >= 80 ? 'bg-emerald-500' :
                                                    bot.rate >= 60 ? 'bg-amber-500' : 'bg-red-500'
                                                }`}
                                                style={{ width: `${bot.rate}%` }}
                                            ></div>
                                        </div>
                                        <div className="text-xs text-slate-500 mt-1">{bot.trades} trades</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {chartType === "distribution" && (
                        <div className="flex items-center justify-center">
                            <div className="w-48 h-48">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie
                                            data={opportunityDistribution}
                                            cx="50%"
                                            cy="50%"
                                            innerRadius={40}
                                            outerRadius={80}
                                            paddingAngle={5}
                                            dataKey="value"
                                        >
                                            {opportunityDistribution.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={entry.color} />
                                            ))}
                                        </Pie>
                                        <Tooltip
                                            contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                                            formatter={(value) => [`${value}%`, 'Share']}
                                        />
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="ml-6 space-y-2">
                                {opportunityDistribution.map((item, i) => (
                                    <div key={i} className="flex items-center gap-3">
                                        <div className="w-3 h-3 rounded" style={{ backgroundColor: item.color }}></div>
                                        <span className="text-sm text-slate-300">{item.name}</span>
                                        <span className="text-sm font-medium text-slate-400">{item.value}%</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </Card>
            );
        };

        // =====================================
        // QUICK ACTIONS PANEL
        // =====================================
        const QuickActionsPanel = ({ onPauseAll, onResumeAll, onRefresh, onForceRunAll }) => (
            <Card className="p-4">
                <h3 className="text-sm font-semibold text-slate-300 mb-4">Quick Actions</h3>
                <div className="space-y-2">
                    <button onClick={onPauseAll} className="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white font-medium rounded-lg transition-colors">
                        <Icons.Pause />
                        Pause All Strategies
                    </button>
                    <button onClick={onResumeAll} className="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-slate-200 font-medium rounded-lg transition-colors">
                        <Icons.Play />
                        Resume All Strategies
                    </button>
                    <button onClick={onRefresh} className="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-slate-200 font-medium rounded-lg transition-colors">
                        <Icons.RefreshCw />
                        Force Data Refresh
                    </button>
                    <button onClick={(e) => onForceRunAll(e)} className="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-red-600 hover:bg-red-500 text-white font-medium rounded-lg transition-all duration-200 hover:scale-105">
                        <Icons.Zap />
                        Force Run All Bots
                    </button>
                </div>
            </Card>
        );

        // =====================================
        // MAIN DASHBOARD COMPONENT
        // =====================================
        function TradingDashboard() {
            const toast = useToast();
            const [confirmDialog, setConfirmDialog] = useState(null);
            const showConfirm = (title, message, onConfirm) => {
                setConfirmDialog({ title, message, onConfirm });
            };
            const hideConfirm = () => setConfirmDialog(null);

            const [currentTime, setCurrentTime] = useState(new Date());
            const [strategies, setStrategies] = useState(defaultStrategies);
            const [positions, setPositions] = useState(defaultPositions);
            const [equityCurve, setEquityCurve] = useState(defaultEquityCurve);

            const [apiStatus, setApiStatus] = useState("HEALTHY");
            const [brokers, setBrokers] = useState(defaultBrokers);
            const isLiveTrading = brokers.some(b => b.mode === 'LIVE' && b.name !== 'Coinbase');
            const [goNoGo, setGoNoGo] = useState(defaultGoNoGo);
            const [circuitBreakers, setCircuitBreakers] = useState(defaultCircuitBreakers);
            const [recentTrades, setRecentTrades] = useState(defaultRecentTrades);
            const [alerts, setAlerts] = useState(defaultAlerts);
            const [aiStatus, setAiStatus] = useState(null);
            // Initialize with default metrics to avoid empty state
            const [aiBotsData, setAiBotsData] = useState({
                sports: null,
                arbitrage: null,
                vision: null,
                prediction: null,
                news: null,
                metrics: {
                    total_ai_bots: 4,
                    active_ai_bots: 0,
                    total_opportunities_found: 0,
                    high_confidence_opportunities: 0,
                    ai_success_rate: 0,
                    ai_cost_today: 0
                }
            });
            const [edges, setEdges] = useState(defaultEdges);
            const [isLoading, setIsLoading] = useState(true);

            // High Risk Trades state
            const [highRiskEnabled, setHighRiskEnabled] = useState(false);
            const [highRiskLoading, setHighRiskLoading] = useState(false);

            // Mock data tracking - shows warning when API returns placeholder data
            const [mockDataSources, setMockDataSources] = useState([]);

            // Fetch High Risk status
            const fetchHighRiskStatus = async () => {
                try {
                    const response = await fetch('/api/high-risk/status');
                    const data = await response.json();
                    if (data.success) {
                        setHighRiskEnabled(data.high_risk_enabled);
                    }
                } catch (error) {
                    console.error('Error fetching high risk status:', error);
                }
            };

            // Toggle High Risk mode
            const handleToggleHighRisk = async () => {
                setHighRiskLoading(true);
                try {
                    const response = await fetch('/api/high-risk/toggle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    if (data.success) {
                        setHighRiskEnabled(data.high_risk_enabled);
                        // Show notification
                        const statusText = data.high_risk_enabled ? 'ENABLED' : 'DISABLED';
                        const botList = data.aggressive_bots?.join(', ') || '';
                        if (data.high_risk_enabled) {
                            toast.addToast(`High Risk Trades ${statusText}  Aggressive bots now active: ${botList}. WARNING: Higher leverage and more aggressive strategies.`, 'warning', 8000);
                        } else {
                            toast.addToast(`High Risk Trades ${statusText}  Aggressive bots deactivated.`, 'info');
                        }
                    } else {
                        toast.addToast('Failed to toggle high risk mode: ' + data.error, 'error');
                    }
                } catch (error) {
                    console.error('Error toggling high risk:', error);
                    toast.addToast('Error toggling high risk mode: ' + error.message, 'error');
                } finally {
                    setHighRiskLoading(false);
                }
            };

            // Fetch data from API
            const fetchData = async () => {
                try {
                    // Fetch core data first (prioritized)
                    const [brokersRes, goNoGoRes, circuitRes, aiRes, highRiskRes] = await Promise.all([
                        fetch('/api/v5/brokers').then(r => r.json()).catch(() => null),
                        fetch('/api/v5/go-no-go').then(r => r.json()).catch(() => null),
                        fetch('/api/v5/circuit-breakers').then(r => r.json()).catch(() => null),
                        fetch('/api/v5/ai-status').then(r => r.json()).catch(() => null),
                        fetch('/api/high-risk/status').then(r => r.json()).catch(() => null)
                    ]);

                    // Set high risk status immediately
                    if (highRiskRes?.success) setHighRiskEnabled(highRiskRes.high_risk_enabled);

                    // Set core data immediately
                    if (brokersRes?.success) setBrokers(brokersRes.brokers);
                    if (goNoGoRes?.success) setGoNoGo(goNoGoRes.checks);
                    if (circuitRes?.success) setCircuitBreakers(circuitRes.breakers);
                    if (aiRes?.success) setAiStatus(aiRes);

                    // Load secondary data without blocking UI
                    setTimeout(async () => {
                        try {
                            const [tradesRes, positionsRes, strategiesRes, aiBotsRes, alertsRes, edgesRes, equityCurveRes] = await Promise.all([
                                fetch('/api/v5/recent-trades').then(r => r.json()).catch(() => null),
                                fetch('/api/v5/positions').then(r => r.json()).catch(() => null),
                                fetch('/api/v5/strategies').then(r => r.json()).catch(() => null),
                                fetchAIBotsData(),
                                fetch('/api/v5/alerts').then(r => r.json()).catch(() => null),
                                fetch('/api/v5/edges').then(r => r.json()).catch(() => null),
                                fetch('/api/v5/equity-curve').then(r => r.json()).catch(() => null)
                            ]);

                            if (tradesRes?.success) setRecentTrades(tradesRes.trades || []);
                            if (positionsRes?.success) setPositions(positionsRes.positions || []);
                            if (strategiesRes?.success) setStrategies(strategiesRes.strategies || []);
                            if (aiBotsRes) setAiBotsData(aiBotsRes);
                            if (alertsRes?.success) setAlerts(alertsRes.alerts || []);
                            if (edgesRes?.success) setEdges({ weather: edgesRes.weather || [], fed: edgesRes.fed || [], sports: edgesRes.sports || [] });
                            if (equityCurveRes?.success) setEquityCurve(equityCurveRes.data || []);

                            // Track which data sources are returning mock data
                            const mockSources = [];
                            if (strategiesRes?.is_mock) mockSources.push('Strategies');
                            if (equityCurveRes?.is_mock) mockSources.push('Equity Curve');
                            if (tradesRes?.is_mock) mockSources.push('Recent Trades');
                            if (alertsRes?.is_mock) mockSources.push('Alerts');
                            setMockDataSources(mockSources);
                        } catch (error) {
                            console.warn("Secondary data loading failed:", error);
                        }
                    }, 100);

                    // Check overall API status
                    const allConnected = brokersRes?.brokers?.every(b => b.status === "CONNECTED");
                    setApiStatus(allConnected ? "HEALTHY" : "DEGRADED");

                } catch (error) {
                    console.error("Error fetching data:", error);
                    setApiStatus("ERROR");
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                // Defer initial data loading to improve DOMContentLoaded performance
                setTimeout(() => {
                    fetchData();
                }, 50);
                // Auto-refresh every 30 seconds (reduced from 10s for performance)
                const dataTimer = setInterval(fetchData, 30000);
                return () => clearInterval(dataTimer);
            }, []);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // Execute action via API
            const executeAction = async (action, params = {}, refreshData = false) => {
                try {
                    const response = await fetch('/api/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, params })
                    });
                    const result = await response.json();
                    if (result.success) {
                        console.log(`Action ${action} succeeded:`, result.message);
                        // Only refresh data if explicitly requested and with delay
                        if (refreshData) {
                            setTimeout(() => {
                                fetchData();
                            }, 500);
                        }
                    } else {
                        console.error(`Action ${action} failed:`, result.message);
                        toast.addToast(`Action failed: ${result.message}`, 'error');
                    }
                    return result;
                } catch (error) {
                    console.error(`Action ${action} error:`, error);
                    toast.addToast(`Error executing action: ${error.message}`, 'error');
                    return { success: false, message: error.message };
                }
            };

            const handleKillSwitch = () => {
                showConfirm("KILL SWITCH", "This will close ALL positions and pause ALL strategies. This cannot be undone.", async () => {
                    hideConfirm();
                    const result = await executeAction('kill_switch');
                    if (result.success) {
                        toast.addToast("Kill switch activated. All positions closed, strategies paused.", 'warning', 8000);
                        setStrategies(prev => prev.map(s => ({ ...s, status: "PAUSED" })));
                        setPositions([]);
                    }
                });
            };

            const handleRefresh = () => {
                console.log("Refreshing data...");
                fetchData();
            };

            const handlePauseResume = async (strategyId) => {
                const strategy = strategies.find(s => s.id === strategyId);
                if (!strategy) return;

                const result = await executeAction('toggle_strategy', { id: strategyId, name: strategy.name });
                if (result.success) {
                    setStrategies(prev => prev.map(s =>
                        s.id === strategyId
                            ? { ...s, status: s.status === "LIVE" ? "PAUSED" : "LIVE" }
                            : s
                    ));
                }
            };

            const handleClosePosition = (position) => {
                showConfirm("Close Position", `Close ${position.symbol} position? This cannot be undone.`, async () => {
                    hideConfirm();
                    const result = await executeAction('close_position', { symbol: position.symbol });
                    if (result.success) {
                        setPositions(prev => prev.filter(p => p.symbol !== position.symbol));
                        toast.addToast(`Closed ${position.symbol} position.`, 'success');
                    }
                });
            };

            const handleCloseAllPositions = () => {
                showConfirm("Close All Positions", "This will close ALL positions. This cannot be undone.", async () => {
                    hideConfirm();
                    const result = await executeAction('close_all');
                    if (result.success) {
                        setPositions([]);
                        toast.addToast("All positions closed.", 'success');
                    }
                });
            };

            const handlePauseAll = async () => {
                const result = await executeAction('pause_all');
                if (result.success) {
                    setStrategies(prev => prev.map(s => ({ ...s, status: "PAUSED" })));
                }
            };

            const handleResumeAll = async () => {
                const result = await executeAction('resume_all');
                if (result.success) {
                    setStrategies(prev => prev.map(s => ({ ...s, status: "LIVE" })));
                }
            };

            const handleForceRunAll = async (event) => {
                showConfirm("Force Run All Bots", "Force run ALL bots immediately out of schedule? This will execute all bots in live trading mode.", async () => {
                    hideConfirm();

                    // Show loading state
                    const button = event.target.closest('button');
                    const originalContent = button.innerHTML;
                    button.disabled = true;
                    button.innerHTML = '<svg class="w-4 h-4 animate-spin mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Running...';

                    try {
                        const result = await executeAction('force_run_all', {}, true);
                        if (result.success) {
                            button.className = "w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-green-600 text-white font-medium rounded-lg transition-all duration-200";
                            button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' + result.message;

                            if (result.details && result.details.opportunities_found > 0) {
                                toast.addToast(`Force run completed! Sports-AI found ${result.details.opportunities_found} opportunities. ${result.details.successful} successful, ${result.details.skipped} skipped, ${result.details.errors} errors.`, 'success', 8000);
                            } else {
                                toast.addToast(result.message, 'success');
                            }

                            setTimeout(() => {
                                button.disabled = false;
                                button.className = "w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-red-600 hover:bg-red-500 text-white font-medium rounded-lg transition-all duration-200 hover:scale-105";
                                button.innerHTML = originalContent;
                            }, 3000);
                        } else {
                            button.className = "w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-red-800 text-white font-medium rounded-lg";
                            button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>Error: ' + result.error;
                            toast.addToast('Error: ' + result.error, 'error');

                            setTimeout(() => {
                                button.disabled = false;
                                button.className = "w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-red-600 hover:bg-red-500 text-white font-medium rounded-lg transition-all duration-200 hover:scale-105";
                                button.innerHTML = originalContent;
                            }, 3000);
                        }
                    } catch (error) {
                        button.className = "w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-red-800 text-white font-medium rounded-lg";
                        button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>Network Error';
                        toast.addToast('Network error: ' + error.message, 'error');

                        setTimeout(() => {
                            button.disabled = false;
                            button.className = "w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-red-600 hover:bg-red-500 text-white font-medium rounded-lg transition-all duration-200 hover:scale-105";
                            button.innerHTML = originalContent;
                        }, 3000);
                    }
                });
            };

            const scrollToAlerts = () => {
                const alertsPanel = document.getElementById('alerts-panel');
                if (alertsPanel) {
                    alertsPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Flash effect to highlight the panel
                    alertsPanel.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.5)';
                    setTimeout(() => {
                        alertsPanel.style.boxShadow = '';
                    }, 2000);
                }
            };

            // KPI Data - computed from real API data
            const totalCapital = 500; // From .env TOTAL_CAPITAL
            const totalPnL = positions.reduce((sum, p) => sum + (p.pnl || p.unrealized_pl || 0), 0);
            // Calculate invested from positions (cost basis), not broker buying power
            const totalInvested = positions.reduce((sum, p) => sum + (p.cost_basis || p.market_value || 0), 0);

            const kpiData = {
                totalPnL: Math.round(totalPnL * 100) / 100,
                pnlChange: 0, // Would need historical data
                tradeCount: recentTrades.length,
                openPositions: positions.length,
                winRate: strategies.length > 0
                    ? Math.round(strategies.reduce((sum, s) => sum + (s.winRate || 0), 0) / strategies.length * 10) / 10
                    : 0,
                profitFactor: totalPnL > 0 ? 1.5 : 0.8,
                drawdown: Math.abs(Math.min(0, totalPnL)),
                drawdownPct: totalCapital > 0 ? Math.round(Math.abs(Math.min(0, totalPnL)) / totalCapital * 1000) / 10 : 0,
                exposure: totalCapital > 0 ? Math.round(totalInvested / totalCapital * 100) : 0,
                invested: Math.round(totalInvested),
                capital: totalCapital,
                brokerExposure: brokers.map(b => ({
                    name: b.name,
                    pct: totalCapital > 0 ? Math.round((b.allocation || b.buyingPower || 0) / totalCapital * 100) : 0,
                    color: b.color || "#666"
                }))
            };

            // AI Data - use fetched or default
            const aiData = aiStatus || {
                regime: "SIDEWAYS",
                regimeConfidence: 78,
                sentiment: 0.23,
                sentimentLabel: "Slight Bull",
                vetoRate: 17,
                activeEdges: 4,
                aiCost: 0.18,
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100 p-4 font-sans">
                    {/* Background grid */}
                    <div className="fixed inset-0 bg-[linear-gradient(rgba(30,41,59,0.3)_1px,transparent_1px),linear-gradient(90deg,rgba(30,41,59,0.3)_1px,transparent_1px)] bg-[size:60px_60px] pointer-events-none" />

                    <div className="relative max-w-[1800px] mx-auto px-2 sm:px-4 space-y-4">
                        {/* Confirm Dialog */}
                        <ConfirmDialog
                            open={!!confirmDialog}
                            title={confirmDialog?.title || ''}
                            message={confirmDialog?.message || ''}
                            onConfirm={confirmDialog?.onConfirm || hideConfirm}
                            onCancel={hideConfirm}
                        />

                        {/* Header */}
                        <Header
                            apiStatus={apiStatus}
                            lastUpdate={currentTime.toLocaleTimeString()}
                            onKillSwitch={handleKillSwitch}
                            onRefresh={fetchData}
                            onAlertClick={scrollToAlerts}
                            alertCount={alerts.filter(a => a.severity === "critical").length}
                            expertMode={isLiveTrading}
                            highRiskEnabled={highRiskEnabled}
                            onToggleHighRisk={handleToggleHighRisk}
                            highRiskLoading={highRiskLoading}
                        />

                        {/* Mock Data Warning */}
                        <MockDataBanner sources={mockDataSources} />

                        {/* KPI Row */}
                        <ErrorBoundary>
                            <KPIRow data={kpiData} isLoading={isLoading} />
                        </ErrorBoundary>

                        {/* Top Row - AI Bots, Broker Health, News Feed */}
                        <ErrorBoundary>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <AIStatusPanel data={aiData} aiBotsData={aiBotsData} />
                                <BrokerHealthPanel brokers={brokers} />
                                <NewsFeedPanel newsData={aiBotsData?.news} />
                            </div>
                        </ErrorBoundary>

                        {/* Circuit Breakers Row */}
                        <ErrorBoundary>
                            <CircuitBreakersPanel breakers={circuitBreakers} />
                        </ErrorBoundary>

                        {/* GO/NO-GO Panel */}
                        <ErrorBoundary>
                            <GoNoGoPanel checks={goNoGo} />
                        </ErrorBoundary>

                        {/* Main Grid */}
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-4">
                            {/* Left Column - Strategies */}
                            <ErrorBoundary>
                                <div className="lg:col-span-3 space-y-4">
                                    <h2 className="text-sm font-semibold text-slate-400 flex items-center gap-2 px-1">
                                        <Icons.Activity />
                                        Active Strategies ({strategies.filter(s => s.status === "LIVE").length}/{strategies.length})
                                    </h2>
                                    {strategies.length === 0 ? (
                                        <Card className="p-6 text-center text-slate-500">
                                            <p className="text-sm">{isLoading ? "Loading strategies..." : "No strategies loaded"}</p>
                                        </Card>
                                    ) : strategies.map(strategy => (
                                        <StrategyCard
                                            key={strategy.id}
                                            strategy={strategy}
                                            onPauseResume={handlePauseResume}
                                            showAI={true}
                                        />
                                    ))}
                                </div>
                            </ErrorBoundary>

                            {/* Center Column - Charts & Positions */}
                            <ErrorBoundary>
                                <div className="lg:col-span-6 space-y-4">
                                    <EquityCurvePanel data={equityCurve} />
                                    <AIPerformanceChartsPanel aiBotsData={aiBotsData} />
                                    <PositionsPanel
                                        positions={positions}
                                        onClose={handleClosePosition}
                                        onCloseAll={handleCloseAllPositions}
                                    />
                                    <RecentTradesPanel trades={recentTrades} />
                                </div>
                            </ErrorBoundary>

                            {/* Right Column - AI Bots & Actions */}
                            <ErrorBoundary>
                                <div className="lg:col-span-3 space-y-4">
                                    <AIBotsPanel aiBotsData={aiBotsData} />
                                    <EdgeTablesPanel edges={edges} />
                                    <QuickActionsPanel
                                        onPauseAll={handlePauseAll}
                                        onResumeAll={handleResumeAll}
                                        onRefresh={handleRefresh}
                                        onForceRunAll={handleForceRunAll}
                                    />
                                    <AlertsPanel alerts={alerts} id="alerts-panel" />
                                </div>
                            </ErrorBoundary>
                        </div>

                        {/* Footer */}
                        <footer className="text-center text-slate-600 text-sm py-6">
                            Trading Dashboard V5 Phase 1  LIVE TRADING  $500 Capital  {currentTime.toLocaleDateString()}
                        </footer>
                    </div>
                </div>
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ToastProvider><TradingDashboard /></ToastProvider>);
    </script>
</body>
</html>
